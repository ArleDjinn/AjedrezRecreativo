{% extends "base.html" %}

{% block title %}Checkout – {{ event.title }}{% endblock %}

{% block content %}
  <h2>Confirmar inscripción</h2>

  <h3>{{ event.title }}</h3>
  <p><strong>Lugar:</strong> {{ event.location_name }}</p>

  <h4>Fechas incluidas</h4>
  <ul>
    {% for occ in occurrences %}
      <li>
        {{ occ.start_dt.strftime("%d-%m-%Y") }}
        · {{ occ.start_dt.strftime("%H:%M") }} – {{ occ.end_dt.strftime("%H:%M") }}
      </li>
    {% endfor %}
  </ul>

  <h4>Total</h4>
  <p><strong>${{ total_price }}</strong></p>

  {% if capacity_left is not none %}
    <p><strong>Cupos disponibles:</strong> {{ capacity_left }}</p>
  {% endif %}

  {% if error %}
    <p style="color: red;"><strong>{{ error }}</strong></p>
  {% endif %}

  <form method="post" action="{{ url_for('checkout.checkout_event_post', event_id=event.id) }}">
    <h4>Datos del comprador</h4>
    <div>
      <label>Nombre</label><br>
      <input name="buyer_name" value="{{ (form.buyer_name if form else '') }}" required>
    </div>
    <div>
      <label>Email</label><br>
      <input type="email" name="buyer_email" value="{{ (form.buyer_email if form else '') }}" required>
    </div>
    <div>
      <label>Teléfono</label><br>
      <input name="buyer_phone" value="{{ (form.buyer_phone if form else '') }}" required>
    </div>

    <hr>

    <h4>Participantes</h4>

    <div>
      <label>Cantidad de participantes</label><br>
      <select id="participant-count" name="participant_count">
        {% set pc = (form.participant_count if form and form.participant_count else '1') %}
        {% for n in range(1, 11) %}
          <option value="{{ n }}" {% if pc|int == n %}selected{% endif %}>{{ n }}</option>
        {% endfor %}
      </select>
    </div>

    <div id="participants-container" style="margin-top: 1rem;"></div>

      <div style="margin-top: 1rem;">
      <button type="submit" {% if capacity_left is defined and capacity_left <= 0 %}disabled{% endif %}>
        Confirmar compra
      </button>
    </div>
  </form>
  <script>
    window.__participants_prefill__ = {{ (form.participants_json if form and form.participants_json else '[]') | safe }};
  </script>
  <script src="{{ url_for('static', filename='js/participants.js') }}"></script>
{% endblock %}
